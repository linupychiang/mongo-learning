## 作用

> 注意意义在于实现 `服务高可用`

复制集的实现依赖于两个方面的功能

- 数据写入时将数据迅速复制到另一个独立节点上
- 在接受写入的节点发生故障时自动选举出一个新的替代节点

在实现高可用的同时，复制集实现了其他几个附加作用：

- 数据分发：将数据从一个区域复制到另一个区域，减少另一个区域的读延迟
- 读写分离：不同类型的压力分别在不同的节点上执行
- 异地容灾：在数据中心故障时快速切换到异地

## 典型复制集结构

一个典型的复制集由 3 个以上具有投票权的节点组成，包括：

- 一个主节点（primary）：接受写入操作和选举时投票
- 两个（或多个）从节点（secondary）：复制主节点上的新数据和选举时投票
- 不推荐使用 Arbiter（投票节点）

## 数据如何复制

当一个修改操作，无论是插入、修改或删除，到达主节点时，它对数据的操作将被记录下来（经过一些必要的转换），这些记录称为 `oplog`

从节点通过在主节点上打开一个 tailable 游标不断获取新进入主节点的 `oplog` ，并在自己的数据上回放，一次保持跟主节点的数据一致。

## 选举

通过选举完成故障修复

1. 具有投票权的节点之间两两发送心跳（默认每 2s）
2. 当 5 次心跳未收到时判断为节点失联
3. 如果失联的是主节点，从节点会发起选举，选出新的主节点
4. 如果失联的是从节点，则不会产生新的选举
5. 选举基于 `RAFT 一致性算法` 实现，选举成功的必要条件时大多数投票节点存活
6. 复制集中最多可以有 50 个节点，但具有投票权的节点最多为 7 个

## 影响选举的因素

a.整个集群必须有大多数节点存活

b.被选举为主节点的节点必须满足：

1. 能够与多数节点建立连接
2. 具有较新的 oplog
3. 具有较高的优先级（如果有配置）

## 常见选项

复制集节点有一下常见的选配项：

1. 是否具有投票权（v 参数）：有则参与投票
2. 优先级（priority 参数）：优先级越高的节点越优先称为主节点。优先级为 0 的节点无法成为主节点
3. 隐藏（hidden 参数）：复制数据，但对应用不可见，隐藏节点可以具有投票权，但优先级必须为 9
4. 延迟（slaveDelay 参数）：复制 n 秒前的数据，保持与主节点的时间差
